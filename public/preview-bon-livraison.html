<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bon de Livraison</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        margin: 0;
        padding: 20px;
        background: #f3f4f6;
      }

      @media print {
        body {
          background: white;
          padding: 0;
        }

        .no-print {
          display: none !important;
        }

        #bon-content {
          margin: 0 !important;
          padding: 0 !important;
        }

        * {
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
          color-adjust: exact !important;
        }

        img {
          max-width: 100% !important;
          height: auto !important;
          page-break-inside: avoid;
        }

        @page {
          margin: 1.5cm;
          size: A4 portrait;
        }
      }
    </style>
  </head>
  <body>
    <!-- Barre d'actions -->
    <div class="no-print fixed top-4 right-4 flex gap-2 z-50">
      <button
        onclick="window.print()"
        class="bg-blue-600 text-white px-4 py-2 rounded shadow hover:bg-blue-700"
      >
        üñ®Ô∏è Imprimer
      </button>
      <button
        onclick="exportPDF()"
        class="bg-green-600 text-white px-4 py-2 rounded shadow hover:bg-green-700"
      >
        üìÑ PDF
      </button>
      <button
        onclick="window.close()"
        class="bg-gray-600 text-white px-4 py-2 rounded shadow hover:bg-gray-700"
      >
        ‚úï Fermer
      </button>
    </div>

    <!-- Contenu du bon de livraison -->
    <div id="bon-content" class="max-w-5xl mx-auto bg-white shadow-lg"></div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="../src/utils/helpers.js"></script>

    <script>
      function toDirectDriveLink(url) {
        if (!url) return "";

        // V√©rifier si c'est un lien Google Drive partag√©
        const match = url.match(
          /https:\/\/drive\.google\.com\/file\/d\/([^/]+)/
        );
        if (match && match[1]) {
          const id = match[1];
          // Utiliser l'API de t√©l√©chargement direct de Google Drive
          return `https://drive.google.com/uc?export=view&id=${id}`;
        }

        return url;
      }

      // R√©cup√©rer la facture depuis localStorage
      const factureData = JSON.parse(localStorage.getItem("facture_preview"));

      if (!factureData) {
        document.getElementById("bon-content").innerHTML = `
      <div class="p-8 text-center">
        <h2 class="text-2xl font-bold text-red-600 mb-4">Erreur</h2>
        <p>Aucun bon de livraison √† afficher.</p>
      </div>
    `;
      } else {
        const settingsStr = localStorage.getItem("app_settings");
        const settings = settingsStr ? JSON.parse(settingsStr) : {};

        // Transformer les liens Drive
        settings.logoEntete = toDirectDriveLink(settings.logoEntete);
        settings.logoPiedPage = toDirectDriveLink(settings.logoPiedPage);

        const clientsStr = localStorage.getItem("app_clients");
        const clients = clientsStr ? JSON.parse(clientsStr) : [];

        const designationsStr = localStorage.getItem("app_designations");
        const designations = designationsStr ? JSON.parse(designationsStr) : [];

        const unitesStr = localStorage.getItem("app_unites");
        const unites = unitesStr ? JSON.parse(unitesStr) : [];

        // G√©n√©rer le HTML du bon de livraison
        generateBonLivraisonHTML(
          factureData,
          settings,
          clients,
          designations,
          unites
        );
      }

      function generateBonLivraisonHTML(
        facture,
        settings,
        clients,
        designations,
        unites
      ) {
        const modele = settings.modeleBonLivraison || "modele1";

        const client = clients.find((c) => c.id == facture.clientId);
        const clientNom = client ? client.nom : "--";

        // Utiliser directement les URLs avec tailles ajust√©es
        const enteteHTML = settings.logoEntete
          ? `<div style="text-align: center; margin-bottom: 20px;">
              <img src="${settings.logoEntete}" alt="Logo" style="max-height: 100px; width: auto; object-fit: contain;" crossorigin="anonymous" onerror="console.error('Erreur chargement logo entete')">
            </div>`
          : "";

        const piedPageHTML = settings.logoPiedPage
          ? `<div style="text-align: center; margin-top: 40px; padding-top: 20px;">
              <img src="${settings.logoPiedPage}" alt="Logo pied de page" style="max-height: 80px; width: auto; object-fit: contain;" crossorigin="anonymous" onerror="console.error('Erreur chargement logo pied')">
            </div>`
          : "";

        const getLigneHTML = (l, idx) => {
          const des = designations.find((d) => d.id == l.designationId);
          const desNom = des ? des.nom : "--";
          const unite =
            des && des.uniteId ? unites.find((u) => u.id == des.uniteId) : null;
          const uniteAbrev = unite ? ` (${unite.abreviation})` : "";

          if (modele === "modele1") {
            return `
          <tr>
            <td style="padding: 12px; border: 1px solid #d1d5db;">${desNom.toUpperCase()}${uniteAbrev}</td>
            <td style="padding: 12px; border: 1px solid #d1d5db; text-align: center;">${
              l.quantite
            }</td>
          </tr>
        `;
          } else if (modele === "modele2") {
            return `
          <tr style="background: ${idx % 2 === 0 ? "#f8f9fa" : "white"};">
            <td style="padding: 12px;">${desNom.toUpperCase()}${uniteAbrev}</td>
            <td style="padding: 12px; text-align: center;">${l.quantite}</td>
          </tr>
        `;
          } else {
            return `
          <tr style="border-bottom: 1px solid #ddd;">
            <td style="padding: 12px 0;">${desNom.toUpperCase()}${uniteAbrev}</td>
            <td style="padding: 12px 0; text-align: center;">${l.quantite}</td>
          </tr>
        `;
          }
        };

        let html = "";

        if (modele === "modele1") {
          html = `
        <div style="font-family: Arial, sans-serif; padding: 40px; max-width: 800px; margin: 0 auto; background: white; color: #000;">
          ${enteteHTML}
          <div style="border-bottom: 3px solid #2563eb; padding-bottom: 20px; margin-bottom: 30px;">
            <h1 style="margin: 0; font-size: 32px; color: #2563eb; text-transform: uppercase;">BON DE LIVRAISON</h1>
            <p style="margin: 5px 0; font-size: 18px; color: #666; text-transform: uppercase;">N¬∞ ${
              facture.numero
            }</p>
            <p style="margin: 5px 0; color: #666; text-transform: uppercase;">DATE : ${window.helpers.formatDateFrancais(
              facture.date
            )}</p>
          </div>
          <div style="margin-bottom: 30px;">
            <p style="margin: 5px 0; text-transform: uppercase;"><strong>CLIENT :</strong> ${clientNom.toUpperCase()}</p>
            ${
              facture.objet
                ? `<p style="margin: 15px 0; font-size: 14px; text-transform: uppercase;"><strong>OBJET :</strong> ${facture.objet}</p>`
                : ""
            }
          </div>
          <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">
            <thead>
              <tr style="background: #f3f4f6;">
                <th style="border: 1px solid #d1d5db; padding: 12px; text-align: left; text-transform: uppercase;">D√âSIGNATION</th>
                <th style="border: 1px solid #d1d5db; padding: 12px; text-align: center; width: 150px; text-transform: uppercase;">QUANTIT√â</th>
              </tr>
            </thead>
            <tbody>
              ${facture.lignes.map((l, idx) => getLigneHTML(l, idx)).join("")}
            </tbody>
          </table>
          <div style="margin-top: 80px; display: flex; justify-content: space-between;">
            <div style="text-align: center; width: 45%;">
              <p style="margin: 0; font-weight: bold; text-transform: uppercase;">LE LIVREUR</p>
            </div>
            <div style="text-align: center; width: 45%;">
              <p style="margin: 0; font-weight: bold; text-transform: uppercase;">LE CLIENT</p>
            </div>
          </div>
          ${piedPageHTML}
        </div>
      `;
        } else if (modele === "modele2") {
          html = `
        <div style="font-family: 'Segoe UI', Tahoma, sans-serif; padding: 50px; max-width: 850px; margin: 0 auto; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #000;">
          <div style="background: white; padding: 40px; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.1);">
            ${enteteHTML}
            <div style="text-align: center; margin-bottom: 40px;">
              <div style="display: inline-block; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 40px; border-radius: 50px; margin-bottom: 20px;">
                <h1 style="margin: 0; font-size: 28px; letter-spacing: 2px; text-transform: uppercase;">BON DE LIVRAISON</h1>
              </div>
              <p style="margin: 10px 0; font-size: 24px; color: #667eea; font-weight: bold; text-transform: uppercase;">‚Ññ ${
                facture.numero
              }</p>
              <p style="margin: 5px 0; color: #666; font-size: 14px; text-transform: uppercase;">üìÖ ${window.helpers.formatDateFrancais(
                facture.date
              )}</p>
            </div>
            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 30px; border-left: 5px solid #667eea;">
              <p style="margin: 5px 0; font-size: 16px; text-transform: uppercase;"><strong style="color: #667eea;">üë§ CLIENT :</strong> ${clientNom.toUpperCase()}</p>
              ${
                facture.objet
                  ? `<p style="margin: 15px 0; font-size: 14px; text-transform: uppercase;"><strong style="color: #667eea;">üìã OBJET :</strong> ${facture.objet}</p>`
                  : ""
              }
            </div>
            <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px; border-radius: 10px; overflow: hidden;">
              <thead>
                <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                  <th style="padding: 15px; text-align: left; text-transform: uppercase;">D√âSIGNATION</th>
                  <th style="padding: 15px; text-align: center; width: 150px; text-transform: uppercase;">QUANTIT√â</th>
                </tr>
              </thead>
              <tbody>
                ${facture.lignes.map((l, idx) => getLigneHTML(l, idx)).join("")}
              </tbody>
            </table>
            <div style="margin-top: 80px; display: flex; justify-content: space-between;">
              <div style="text-align: center; width: 45%;">
                <p style="margin: 0; font-weight: bold; text-transform: uppercase; color: #667eea;">LE LIVREUR</p>
              </div>
              <div style="text-align: center; width: 45%;">
                <p style="margin: 0; font-weight: bold; text-transform: uppercase; color: #667eea;">LE CLIENT</p>
              </div>
            </div>
            ${piedPageHTML}
          </div>
        </div>
      `;
        } else if (modele === "modele3") {
          html = `
        <div style="font-family: 'Courier New', monospace; padding: 60px 40px; max-width: 750px; margin: 0 auto; background: white; color: #000;">
          ${enteteHTML}
          <div style="border-bottom: 1px solid #000; padding-bottom: 10px; margin-bottom: 40px;">
            <h1 style="margin: 0; font-size: 24px; font-weight: normal; letter-spacing: 5px; text-transform: uppercase;">BON DE LIVRAISON</h1>
          </div>
          <div style="margin-bottom: 40px; line-height: 1.8;">
            <p style="margin: 5px 0; text-transform: uppercase;">N¬∞ ${
              facture.numero
            }</p>
            <p style="margin: 5px 0; text-transform: uppercase;">DATE: ${window.helpers.formatDateFrancais(
              facture.date
            )}</p>
            <p style="margin: 5px 0; text-transform: uppercase;">CLIENT: ${clientNom.toUpperCase()}</p>
            ${
              facture.objet
                ? `<p style="margin: 15px 0; text-transform: uppercase;">OBJET: ${facture.objet}</p>`
                : ""
            }
          </div>
          <table style="width: 100%; border-collapse: collapse; margin-bottom: 40px;">
            <thead>
              <tr style="border-bottom: 2px solid #000;">
                <th style="padding: 10px 0; text-align: left; font-weight: normal; text-transform: uppercase;">D√âSIGNATION</th>
                <th style="padding: 10px 0; text-align: center; width: 150px; font-weight: normal; text-transform: uppercase;">QUANTIT√â</th>
              </tr>
            </thead>
            <tbody>
              ${facture.lignes.map((l, idx) => getLigneHTML(l, idx)).join("")}
            </tbody>
          </table>
          <div style="margin-top: 80px; display: flex; justify-content: space-between;">
            <div style="text-align: center; width: 45%;">
              <p style="margin: 0; font-weight: bold; text-transform: uppercase;">LE LIVREUR</p>
            </div>
            <div style="text-align: center; width: 45%;">
              <p style="margin: 0; font-weight: bold; text-transform: uppercase;">LE CLIENT</p>
            </div>
          </div>
          ${piedPageHTML}
        </div>
      `;
        }

        document.getElementById("bon-content").innerHTML = html;
      }

      function exportPDF() {
        const element = document.getElementById("bon-content");
        const factureData = JSON.parse(localStorage.getItem("facture_preview"));
        const filename = `bon_livraison_${factureData.numero.replace(
          /[^a-zA-Z0-9]/g,
          "_"
        )}.pdf`;

        html2pdf()
          .set({
            margin: 10,
            filename: filename,
            html2canvas: { scale: 2, useCORS: true },
            jsPDF: { unit: "mm", format: "a4", orientation: "portrait" },
          })
          .from(element)
          .save();
      }
    </script>
  </body>
</html>
